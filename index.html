<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>林業GIS Pro - Field</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { overscroll-behavior-y: none; user-select: none; -webkit-user-select: none; touch-action: none; }
        .map-bg { background-color: #f8fafc; background-image: radial-gradient(#cbd5e1 1px, transparent 1px); background-size: 20px 20px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Drawer Animations */
        .drawer-open { transform: translateY(0); }
        .drawer-closed { transform: translateY(100%); }
        .menu-open { transform: translateX(0); }
        .menu-closed { transform: translateX(100%); }
        
        /* ペイントモード時のマップハイライト */
        .record-mode-active { box-shadow: inset 0 0 0 4px #eab308; }
    </style>
</head>
<body class="bg-slate-900 h-screen w-screen overflow-hidden font-sans text-slate-800 relative">

    <!-- ==========================================
         Layer 1: Map (Full Screen)
    =========================================== -->
    <main id="map-container" class="absolute inset-0 map-bg flex justify-center items-center overflow-hidden transition-all duration-300">
        <!-- Canvas for Map, Polygons, and Paint -->
        <canvas id="mapCanvas" class="bg-transparent touch-none"></canvas>
    </main>

    <!-- ==========================================
         Layer 2: Overlays (Properties & Controls)
    =========================================== -->
    
    <!-- Feature Properties Card (Loaded from Check-in QR) -->
    <div id="property-card" class="absolute top-4 left-4 right-16 bg-white/90 backdrop-blur-sm p-3 rounded-2xl shadow-lg border border-slate-200 pointer-events-auto transition-opacity">
        <div class="flex items-start gap-3">
            <div class="bg-emerald-100 p-2 rounded-xl text-emerald-600">
                <i data-lucide="map-pin" class="w-6 h-6"></i>
            </div>
            <div>
                <h2 class="text-sm font-bold text-slate-800" id="prop-site-name">未設定 (チェックイン待機)</h2>
                <div class="grid grid-cols-2 gap-x-4 mt-1 text-xs text-slate-500">
                    <p>ID: <span id="prop-site-id" class="font-mono text-slate-700">-</span></p>
                    <p>面積: <span id="prop-site-area" class="text-slate-700">-</span> ha</p>
                    <p>班: <span id="prop-team" class="text-slate-700">-</span></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Right Controls -->
    <div class="absolute top-4 right-4 flex flex-col gap-3">
        <button id="btn-toggle-menu" class="w-12 h-12 bg-white/90 backdrop-blur-sm rounded-full shadow-lg flex justify-center items-center text-slate-700 active:bg-slate-200 transition-colors">
            <i data-lucide="menu" class="w-6 h-6"></i>
        </button>
        <button id="btn-toggle-gps" class="w-12 h-12 bg-white/90 backdrop-blur-sm rounded-full shadow-lg flex justify-center items-center text-slate-700 active:bg-slate-200 transition-colors">
            <i data-lucide="navigation" id="icon-gps" class="w-6 h-6"></i>
        </button>
    </div>

    <!-- Bottom Right FAB (Floating Action Button) - Record Mode Toggle -->
    <button id="btn-open-record" class="absolute bottom-8 right-6 px-6 py-4 bg-yellow-500 text-yellow-950 font-bold rounded-full shadow-[0_10px_25px_-5px_rgba(234,179,8,0.5)] active:scale-95 transition-all flex items-center gap-3 border-2 border-yellow-300">
        <i data-lucide="edit-3" class="w-7 h-7"></i>
        <span class="text-lg tracking-wide">作業記録</span>
    </button>

    <!-- ==========================================
         Layer 3: Drawers & Modals
    =========================================== -->

    <!-- Management Menu (Right Slide) -->
    <div id="side-menu" class="absolute top-0 right-0 h-full w-72 bg-slate-900 text-white shadow-2xl menu-closed transition-transform duration-300 z-40 flex flex-col">
        <div class="p-5 flex justify-between items-center border-b border-slate-700">
            <h3 class="font-bold text-lg">メニュー・管理</h3>
            <button id="btn-close-menu" class="p-2 text-slate-400 active:text-white"><i data-lucide="x"></i></button>
        </div>
        <div class="p-4 flex flex-col gap-4 flex-1 overflow-y-auto">
            
            <button id="btn-simulate-checkin" class="flex flex-col items-center gap-2 p-4 bg-blue-600 rounded-xl active:bg-blue-700 text-sm font-bold shadow-md">
                <i data-lucide="qr-code" class="w-6 h-6"></i>
                現場看板QRをスキャン<br><span class="text-xs font-normal text-blue-200">(ポリゴン・プロパティ読込)</span>
            </button>

            <button id="btn-show-sync" class="flex flex-col items-center gap-2 p-4 bg-emerald-600 rounded-xl active:bg-emerald-700 text-sm font-bold shadow-md">
                <i data-lucide="refresh-cw" class="w-6 h-6"></i>
                Sync Hub (データ合体)<br><span class="text-xs font-normal text-emerald-200">(仲間と進捗を同期)</span>
            </button>
            
            <hr class="border-slate-700 my-2">

            <div>
                <label class="text-xs text-slate-400 font-bold mb-2 block">オフライン地図 (GeoTIFF代替)</label>
                <input type="file" id="map-upload" accept="image/*" class="hidden">
                <button onclick="document.getElementById('map-upload').click()" class="w-full flex items-center justify-center gap-2 p-3 bg-slate-800 rounded-xl active:bg-slate-700 text-sm">
                    <i data-lucide="image" class="w-4 h-4"></i> 背景画像をロード
                </button>
            </div>
            
            <div class="mt-auto bg-slate-800 p-4 rounded-xl border border-slate-700">
                <div class="text-xs text-slate-400 mb-2 font-bold">現在のローカル実績</div>
                <div class="grid grid-cols-2 gap-2 text-sm">
                    <div>伐採: <span id="menu-felling" class="font-bold text-yellow-400">0</span></div>
                    <div>集材: <span id="menu-yarding" class="font-bold text-orange-400">0</span></div>
                    <div>造材: <span id="menu-bucking" class="font-bold text-sky-400">0</span></div>
                    <div>搬出: <span id="menu-forwarding" class="font-bold text-green-400">0</span></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Record Bottom Sheet (Bottom Slide) -->
    <div id="record-sheet" class="absolute bottom-0 w-full bg-slate-100 rounded-t-3xl shadow-[0_-15px_40px_-15px_rgba(0,0,0,0.3)] drawer-closed transition-transform duration-300 z-30 flex flex-col border-t border-slate-200">
        
        <div class="flex justify-between items-center p-3 border-b border-slate-200 bg-white rounded-t-3xl">
            <div class="flex items-center gap-2 px-2 text-yellow-600 font-bold">
                <i data-lucide="edit-3" class="w-5 h-5"></i> 記録モード起動中
            </div>
            <button id="btn-close-record" class="px-5 py-2 bg-slate-800 text-white font-bold rounded-full shadow-md active:bg-slate-700 text-sm flex items-center gap-2">
                保存して戻る <i data-lucide="check" class="w-4 h-4"></i>
            </button>
        </div>

        <div class="p-3 flex flex-col gap-3">
            <!-- Counters -->
            <div class="grid grid-cols-4 gap-2">
                <button id="btn-count-felling" class="py-3 bg-white border border-slate-200 text-yellow-500 font-bold rounded-xl active:bg-yellow-50 shadow-sm flex flex-col items-center justify-center gap-1">
                    <span class="text-xs text-slate-500">伐採</span><span class="text-lg">+10</span>
                </button>
                <button id="btn-count-yarding" class="py-3 bg-white border border-slate-200 text-orange-500 font-bold rounded-xl active:bg-orange-50 shadow-sm flex flex-col items-center justify-center gap-1">
                    <span class="text-xs text-slate-500">集材</span><span class="text-lg">+10</span>
                </button>
                <button id="btn-count-bucking" class="py-3 bg-white border border-slate-200 text-sky-500 font-bold rounded-xl active:bg-sky-50 shadow-sm flex flex-col items-center justify-center gap-1">
                    <span class="text-xs text-slate-500">造材</span><span class="text-lg">+10</span>
                </button>
                <button id="btn-count-forwarding" class="py-3 bg-white border border-slate-200 text-green-500 font-bold rounded-xl active:bg-green-50 shadow-sm flex flex-col items-center justify-center gap-1">
                    <span class="text-xs text-slate-500">搬出</span><span class="text-lg">+1</span>
                </button>
            </div>

            <!-- Brushes -->
            <div class="flex overflow-x-auto gap-3 py-1 no-scrollbar snap-x">
                <button id="btn-brush-1" class="brush-btn snap-center shrink-0 w-24 py-3 bg-yellow-400 text-yellow-900 font-bold rounded-2xl border-4 border-transparent flex flex-col items-center shadow-md">
                    <i data-lucide="axe" class="w-6 h-6"></i><span class="text-xs mt-1">伐採済</span>
                </button>
                <button id="btn-brush-2" class="brush-btn snap-center shrink-0 w-24 py-3 bg-orange-400 text-orange-900 font-bold rounded-2xl border-4 border-transparent flex flex-col items-center shadow-md">
                    <i data-lucide="tractor" class="w-6 h-6"></i><span class="text-xs mt-1">集材済</span>
                </button>
                <button id="btn-brush-3" class="brush-btn snap-center shrink-0 w-24 py-3 bg-sky-400 text-sky-900 font-bold rounded-2xl border-4 border-transparent flex flex-col items-center shadow-md">
                    <i data-lucide="hammer" class="w-6 h-6"></i><span class="text-xs mt-1">造材済</span>
                </button>
                <button id="btn-brush-4" class="brush-btn snap-center shrink-0 w-24 py-3 bg-green-400 text-green-900 font-bold rounded-2xl border-4 border-transparent flex flex-col items-center shadow-md">
                    <i data-lucide="truck" class="w-6 h-6"></i><span class="text-xs mt-1">搬出済</span>
                </button>
                <button id="btn-brush-0" class="brush-btn snap-center shrink-0 w-24 py-3 bg-slate-200 text-slate-700 font-bold rounded-2xl border-4 border-transparent flex flex-col items-center shadow-md">
                    <i data-lucide="eraser" class="w-6 h-6"></i><span class="text-xs mt-1">消しゴム</span>
                </button>
            </div>
            
            <p class="text-center text-xs text-slate-400 font-bold">↑ 地図をなぞってエリアを記録</p>
        </div>
    </div>

    <!-- Sync Modal (QR Generator) -->
    <!-- (Previous sync modal code kept intact but hidden initially) -->
    <div id="sync-modal" class="hidden fixed inset-0 bg-slate-900/90 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-sm overflow-hidden shadow-2xl flex flex-col">
            <div class="bg-blue-600 p-4 flex justify-between items-center text-white">
                <h2 class="font-bold flex items-center gap-2"><i data-lucide="refresh-cw"></i> Sync Hub</h2>
                <button id="btn-close-sync-modal" class="p-1"><i data-lucide="x"></i></button>
            </div>
            <div class="p-5 flex flex-col items-center gap-4">
                <div id="qrcode-container" class="bg-white p-3 border-2 border-slate-100 rounded-xl"></div>
                <button id="btn-simulate-scan" class="w-full py-3 bg-slate-800 text-white rounded-xl font-bold shadow active:bg-slate-700">
                    仲間のQRをスキャン(模擬)
                </button>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        // --- Core Application State ---
        const GRID_SIZE = 40;
        let gridData = new Uint8Array(GRID_SIZE * GRID_SIZE);
        
        let counters = { felling: 0, yarding: 0, bucking: 0, forwarding: 0 };
        let currentBrush = 1; 
        
        // Mode State
        let isRecordMode = false;

        // Map/GIS State
        let bgMapImage = null;
        let gpsPosition = null;
        let gpsWatchId = null;
        
        // Mock Feature Polygon Data (Loaded from Check-in QR)
        let sitePolygon = null;

        const STATE_COLORS = {
            1: 'rgba(250, 204, 21, 0.7)', 2: 'rgba(249, 115, 22, 0.7)', 
            3: 'rgba(56, 189, 248, 0.7)', 4: 'rgba(74, 222, 128, 0.8)'
        };

        // --- Canvas Setup ---
        const canvas = document.getElementById('mapCanvas');
        const ctx = canvas.getContext('2d');
        const container = document.getElementById('map-container');

        function resizeCanvas() {
            // Keep it large enough to cover screen
            const size = Math.max(container.clientWidth, container.clientHeight);
            canvas.width = size;
            canvas.height = size;
            renderCanvas();
        }
        window.addEventListener('resize', resizeCanvas);

        function renderCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (bgMapImage) ctx.drawImage(bgMapImage, 0, 0, canvas.width, canvas.height);

            // 1. Draw Feature Polygon (if loaded)
            if (sitePolygon) {
                ctx.beginPath();
                ctx.moveTo(sitePolygon[0].x * canvas.width, sitePolygon[0].y * canvas.height);
                for(let i=1; i<sitePolygon.length; i++) {
                    ctx.lineTo(sitePolygon[i].x * canvas.width, sitePolygon[i].y * canvas.height);
                }
                ctx.closePath();
                ctx.fillStyle = 'rgba(255, 255, 255, 0.2)';
                ctx.fill();
                ctx.strokeStyle = '#ef4444'; // red-500
                ctx.lineWidth = 3;
                ctx.setLineDash([10, 5]);
                ctx.stroke();
                ctx.setLineDash([]); // reset
            }

            // 2. Draw Painted Cells
            const cellW = canvas.width / GRID_SIZE;
            const cellH = canvas.height / GRID_SIZE;
            for (let y = 0; y < GRID_SIZE; y++) {
                for (let x = 0; x < GRID_SIZE; x++) {
                    let val = gridData[y * GRID_SIZE + x];
                    if (val > 0) {
                        ctx.fillStyle = STATE_COLORS[val];
                        ctx.fillRect(x * cellW, y * cellH, cellW + 0.5, cellH + 0.5); 
                    }
                }
            }

            // 3. Draw Grid Lines (Only if in record mode for clarity, or always)
            if (isRecordMode) {
                ctx.strokeStyle = 'rgba(148, 163, 184, 0.4)';
                ctx.lineWidth = 1;
                ctx.beginPath();
                for (let i = 0; i <= GRID_SIZE; i++) {
                    ctx.moveTo(i * cellW, 0); ctx.lineTo(i * cellW, canvas.height);
                    ctx.moveTo(0, i * cellH); ctx.lineTo(canvas.width, i * cellH);
                }
                ctx.stroke();
            }

            // 4. Draw GPS Current Location
            if (gpsPosition) {
                ctx.beginPath(); ctx.arc(gpsPosition.x, gpsPosition.y, 14, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(59, 130, 246, 0.3)'; ctx.fill();
                ctx.beginPath(); ctx.arc(gpsPosition.x, gpsPosition.y, 6, 0, Math.PI * 2);
                ctx.fillStyle = '#3b82f6'; ctx.fill();
                ctx.strokeStyle = '#ffffff'; ctx.lineWidth = 2; ctx.stroke();
            }
        }

        // --- Interaction Logic (Record Mode ONLY) ---
        let isDrawing = false;
        let lastX = -1, lastY = -1;

        function getGridCoords(clientX, clientY) {
            const rect = canvas.getBoundingClientRect();
            const x = Math.floor(((clientX - rect.left) / rect.width) * GRID_SIZE);
            const y = Math.floor(((clientY - rect.top) / rect.height) * GRID_SIZE);
            return { x: Math.max(0, Math.min(GRID_SIZE - 1, x)), y: Math.max(0, Math.min(GRID_SIZE - 1, y)) };
        }

        function applyBrush(gx, gy) {
            if (!isRecordMode) return; // セーフティガード：記録モード以外は塗れない
            const idx = gy * GRID_SIZE + gx;
            if (currentBrush === 0) gridData[idx] = 0;
            else gridData[idx] = Math.max(gridData[idx], currentBrush);
        }

        function drawLine(x0, y0, x1, y1) {
            let dx = Math.abs(x1 - x0), dy = Math.abs(y1 - y0);
            let sx = (x0 < x1) ? 1 : -1, sy = (y0 < y1) ? 1 : -1;
            let err = dx - dy;
            while (true) {
                applyBrush(x0, y0);
                if (x0 === x1 && y0 === y1) break;
                let e2 = 2 * err;
                if (e2 > -dy) { err -= dy; x0 += sx; }
                if (e2 < dx) { err += dx; y0 += sy; }
            }
        }

        function handleStart(e) {
            if (!isRecordMode) return; // 閲覧モード時は無視（または地図移動処理へ）
            isDrawing = true;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            const coords = getGridCoords(clientX, clientY);
            lastX = coords.x; lastY = coords.y;
            applyBrush(coords.x, coords.y);
            renderCanvas();
        }

        function handleMove(e) {
            if (!isDrawing || !isRecordMode) return;
            e.preventDefault();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            const coords = getGridCoords(clientX, clientY);
            drawLine(lastX, lastY, coords.x, coords.y);
            lastX = coords.x; lastY = coords.y;
            renderCanvas();
        }

        function handleEnd() { isDrawing = false; }

        canvas.addEventListener('mousedown', handleStart);
        canvas.addEventListener('mousemove', handleMove);
        window.addEventListener('mouseup', handleEnd);
        canvas.addEventListener('touchstart', handleStart, { passive: false });
        canvas.addEventListener('touchmove', handleMove, { passive: false });
        window.addEventListener('touchend', handleEnd);

        // --- UI Interactions (Drawers & Modals) ---

        // Right Menu Drawer
        const sideMenu = document.getElementById('side-menu');
        document.getElementById('btn-toggle-menu').addEventListener('click', () => {
            sideMenu.classList.remove('menu-closed');
            sideMenu.classList.add('menu-open');
        });
        document.getElementById('btn-close-menu').addEventListener('click', () => {
            sideMenu.classList.remove('menu-open');
            sideMenu.classList.add('menu-closed');
        });

        // Bottom Record Sheet
        const recordSheet = document.getElementById('record-sheet');
        const mapCont = document.getElementById('map-container');
        const fab = document.getElementById('btn-open-record');
        
        document.getElementById('btn-open-record').addEventListener('click', () => {
            isRecordMode = true;
            recordSheet.classList.remove('drawer-closed');
            recordSheet.classList.add('drawer-open');
            mapCont.classList.add('record-mode-active');
            fab.style.display = 'none'; // FABを隠す
            renderCanvas(); // グリッド線を表示
        });
        
        document.getElementById('btn-close-record').addEventListener('click', () => {
            isRecordMode = false;
            recordSheet.classList.remove('drawer-open');
            recordSheet.classList.add('drawer-closed');
            mapCont.classList.remove('record-mode-active');
            fab.style.display = 'flex'; // FABを戻す
            updateMenuCounters(); // メニューの数字を更新
            renderCanvas(); // グリッド線を隠す
        });

        // --- Mock Check-in QR (Load Polygon & Properties) ---
        document.getElementById('btn-simulate-checkin').addEventListener('click', () => {
            // シミュレーション: QRから現場情報（プロパティ）とポリゴン（境界）を取得したとする
            document.getElementById('prop-site-name').textContent = "清水山林 (1班用)";
            document.getElementById('prop-site-id').textContent = "PRJ-2026";
            document.getElementById('prop-site-area').textContent = "4.2";
            document.getElementById('prop-team').textContent = "Aチーム";
            
            // 画面相対座標でのダミーポリゴン (0.0~1.0)
            sitePolygon = [
                {x: 0.2, y: 0.2}, {x: 0.8, y: 0.3}, 
                {x: 0.7, y: 0.7}, {x: 0.3, y: 0.6}
            ];
            
            // プロパティカードをハイライト
            const card = document.getElementById('property-card');
            card.classList.add('ring-4', 'ring-emerald-400');
            setTimeout(() => card.classList.remove('ring-4', 'ring-emerald-400'), 1000);

            // メニューを閉じて地図描画
            sideMenu.classList.remove('menu-open');
            sideMenu.classList.add('menu-closed');
            renderCanvas();
        });

        // --- Background Map Upload ---
        document.getElementById('map-upload').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => { bgMapImage = img; renderCanvas(); };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });

        // --- Counters Logic ---
        function updateMenuCounters() {
            document.getElementById('menu-felling').textContent = counters.felling;
            document.getElementById('menu-yarding').textContent = counters.yarding;
            document.getElementById('menu-bucking').textContent = counters.bucking;
            document.getElementById('menu-forwarding').textContent = counters.forwarding;
        }

        function handleCounter(type, amount, btnId) {
            counters[type] += amount;
            const btn = document.getElementById(btnId);
            btn.classList.add('bg-slate-200');
            setTimeout(() => btn.classList.remove('bg-slate-200'), 150);
        }
        
        document.getElementById('btn-count-felling').addEventListener('click', () => handleCounter('felling', 10, 'btn-count-felling'));
        document.getElementById('btn-count-yarding').addEventListener('click', () => handleCounter('yarding', 10, 'btn-count-yarding'));
        document.getElementById('btn-count-bucking').addEventListener('click', () => handleCounter('bucking', 10, 'btn-count-bucking'));
        document.getElementById('btn-count-forwarding').addEventListener('click', () => handleCounter('forwarding', 1, 'btn-count-forwarding'));

        // --- Brush Logic ---
        function updateBrushUI() {
            [1, 2, 3, 4, 0].forEach(val => {
                const el = document.getElementById(`btn-brush-${val}`);
                el.classList.remove('border-slate-800', 'scale-105');
                if (currentBrush === val) el.classList.add('border-slate-800', 'scale-105');
            });
        }
        [1, 2, 3, 4, 0].forEach(val => {
            document.getElementById(`btn-brush-${val}`).addEventListener('click', () => {
                currentBrush = val; updateBrushUI();
            });
        });

        // --- Sync Hub (QR Generation) ---
        const syncModal = document.getElementById('sync-modal');
        document.getElementById('btn-show-sync').addEventListener('click', () => {
            sideMenu.classList.remove('menu-open');
            sideMenu.classList.add('menu-closed');
            
            // ペイロード構築 (RLE等省略、ダミー表示)
            const payloadStr = JSON.stringify({p: "compressed_data_mock", c: [counters.felling, counters.yarding, counters.bucking, counters.forwarding]});
            const qrContainer = document.getElementById('qrcode-container');
            qrContainer.innerHTML = '';
            new QRCode(qrContainer, { text: payloadStr, width: 200, height: 200 });
            
            syncModal.classList.remove('hidden');
        });
        document.getElementById('btn-close-sync-modal').addEventListener('click', () => syncModal.classList.add('hidden'));
        document.getElementById('btn-simulate-scan').addEventListener('click', () => {
            alert("他端末のQRをスキャンしてデータを合体しました！");
            syncModal.classList.add('hidden');
        });

        // --- GPS Simulation ---
        document.getElementById('btn-toggle-gps').addEventListener('click', () => {
            const btn = document.getElementById('btn-toggle-gps');
            const icon = document.getElementById('icon-gps');
            if (!gpsWatchId) {
                btn.classList.replace('bg-white/90', 'bg-blue-600');
                icon.classList.replace('text-slate-700', 'text-white');
                let mockX = canvas.width/2, mockY = canvas.height/2;
                gpsWatchId = setInterval(() => {
                    mockX += (Math.random() - 0.5) * 20; mockY += (Math.random() - 0.5) * 20;
                    gpsPosition = { x: mockX, y: mockY };
                    renderCanvas();
                }, 1000);
            } else {
                clearInterval(gpsWatchId); gpsWatchId = null; gpsPosition = null;
                btn.classList.replace('bg-blue-600', 'bg-white/90');
                icon.classList.replace('text-white', 'text-slate-700');
                renderCanvas();
            }
        });

        // Initialize
        resizeCanvas();
        updateBrushUI();
    </script>
</body>
</html>
